# Inception-Tutorial
Tutorial to install Debian virtual machine with multiple virtualised Docker images

## 1- _Descargar imagen de la maquina virtual_ üíø

[Click aqui](https://www.debian.org/distrib/index.es.html) para redireccionarte a la URL donde puedes descargar la ISO de manera segura.

## 2- Instalacion de la maquina üõ†

Para realizar la instalaci√≥n se requiere de un software de virtualizaci√≥n. En este tutorial haremos uso de [VirtualBox](https://www.virtualbox.org/). Si ya tienes VirtualBox instalado y dispones de la ISO Debian ya podemos empezar con el tutorial.

1 ‚ó¶ Debemos abrir VirtualBox y pinchar sobre ```New```



2 ‚ó¶ Escogemos el nombre de nuestra m√°quina y la carpeta donde estar√° ubicada. Importante introducir la maquina dentro de la carpeta sgoinfre ya que si no la ubicamos ah√≠ nos quedaremos sin espacio y fallar√° la instalaci√≥n (dependiendo del campus la ruta de sgoinfre puede cambiar).

<img width="950" alt="Screen Shot 2023-09-29 at 12 21 06 PM" src="https://github.com/gemartin99/Inception-Tutorial/66915274/3d7d6d60-57db-41e2-aebb-65f24b96fe61">

3 ‚ó¶

<img width="948" alt="Screen Shot 2023-09-29 at 12 22 16 PM" src="https://github.com/gemartin99/Inception-Tutorial/66915274/839003e3-f27a-4408-be9a-7a40193a961b">

4 ‚ó¶

<img width="952" alt="Screen Shot 2023-09-29 at 12 22 36 PM" src="https://github.com/gemartin99/Inception-Tutorial/assets/66915274/188be130-e3e0-4227-a054-f2cc77ea3654">

5 ‚ó¶

<img width="949" alt="Screen Shot 2023-09-29 at 12 23 01 PM" src="https://github.com/gemartin99/Inception-Tutorial/assets/66915274/82b7927b-59ac-4d8a-a1e0-97d95880300c">

6 ‚ó¶

<img width="950" alt="Screen Shot 2023-09-29 at 12 23 21 PM" src="https://github.com/gemartin99/Inception-Tutorial/assets/66915274/138b9feb-ffc4-41e1-947e-597011970a33">


üëÄ 

<img width="671" alt="Screen Shot 2023-09-29 at 12 37 18 PM" src="https://github.com/gemartin99/Inception-Tutorial/assets/66915274/d0965811-4bb4-4238-904a-bbcfd6de571b">


<img width="637" alt="Screen Shot 2023-09-29 at 12 37 28 PM" src="https://github.com/gemartin99/Inception-Tutorial/assets/66915274/365e2e2e-c38b-4e8a-8dcb-5c85dfc38c89">


<img width="799" alt="Screen Shot 2023-09-29 at 12 38 26 PM" src="https://github.com/gemartin99/Inception-Tutorial/assets/66915274/8f5d0b44-08f4-495f-8a47-9b94a5222ba0">

<img width="798" alt="Screen Shot 2023-09-29 at 12 38 37 PM" src="https://github.com/gemartin99/Inception-Tutorial/66915274/9ceafe0e-ba3c-4c1e-a0f3-ce66d380bc20">

<img width="806" alt="Screen Shot 2023-09-29 at 12 38 52 PM" src="https://github.com/gemartin99/Inception-Tutorial/assets/66915274/08e55c36-949a-4c2a-bae5-7c1a12eeea9c">

<img width="799" alt="Screen Shot 2023-09-29 at 12 39 58 PM" src="https://github.com/gemartin99/Inception-Tutorial/assets/66915274/3de03823-1842-4d30-922c-751b51f3db8b">

<img width="802" alt="Screen Shot 2023-09-29 at 12 40 13 PM" src="https://github.com/gemartin99/Inception-Tutorial/assets/66915274/b5b2d669-a7df-4643-87b8-95cfc25adc0a">

<img width="801" alt="Screen Shot 2023-09-29 at 12 40 32 PM" src="https://github.com/gemartin99/Inception-Tutorial/assets/66915274/cab79158-0dd7-4782-8cc5-ac42a17a4e3e">

<img width="797" alt="Screen Shot 2023-09-29 at 12 40 45 PM" src="https://github.com/gemartin99/Inception-Tutorial/assets/66915274/cef7fcc6-a8b6-435d-a840-9c7126afeb8f">

<img width="797" alt="Screen Shot 2023-09-29 at 12 40 54 PM" src="https://github.com/gemartin99/Inception-Tutorial/assets/66915274/23c43cac-57b6-485d-881d-580f3ac40410">

<img width="799" alt="Screen Shot 2023-09-29 at 12 41 10 PM" src="https://github.com/gemartin99/Inception-Tutorial/assets/66915274/3f452fe9-67c0-474d-8676-c3d166dd1eb2">

<img width="804" alt="Screen Shot 2023-09-29 at 12 41 19 PM" src="https://github.com/gemartin99/Inception-Tutorial/assets/66915274/849ee5e0-3c49-4a4f-9d59-114c14e8ca1f">

<img width="798" alt="Screen Shot 2023-09-29 at 12 41 37 PM" src="https://github.com/gemartin99/Inception-Tutorial/assets/66915274/3bc537f3-399c-4f6b-b4b3-eb4701bf8e89">

<img width="794" alt="Screen Shot 2023-09-29 at 12 41 47 PM" src="https://github.com/gemartin99/Inception-Tutorial/assets/66915274/09344f70-8e13-47a2-ab9b-095c303bf1df">

<img width="797" alt="Screen Shot 2023-09-29 at 12 41 57 PM" src="https://github.com/gemartin99/Inception-Tutorial/assets/66915274/c8f5334b-7b16-4c89-8692-ac9bab27c8c4">

<img width="795" alt="Screen Shot 2023-09-29 at 12 42 08 PM" src="https://github.com/gemartin99/Inception-Tutorial/assets/66915274/2607be77-4b14-4be0-9034-bbc205906939">

<img width="794" alt="Screen Shot 2023-09-29 at 12 42 24 PM" src="https://github.com/gemartin99/Inception-Tutorial/assets/66915274/7cd2cf99-9dea-4bcb-bb6e-c82593a99d26">

<img width="799" alt="Screen Shot 2023-09-29 at 12 45 36 PM" src="https://github.com/gemartin99/Inception-Tutorial/assets/66915274/99be4916-4548-4abe-83a6-654b4a583628">

<img width="793" alt="Screen Shot 2023-09-29 at 12 45 47 PM" src="https://github.com/gemartin99/Inception-Tutorial/assets/66915274/f301cefd-d55c-448a-be5d-e9caedb929f5">

<img width="800" alt="Screen Shot 2023-09-29 at 12 45 57 PM" src="https://github.com/gemartin99/Inception-Tutorial/assets/66915274/d4026b01-2208-400a-95f6-d9b565626497">

<img width="795" alt="Screen Shot 2023-09-29 at 12 46 06 PM" src="https://github.com/gemartin99/Inception-Tutorial/assets/66915274/667eac87-9653-4d94-9864-056dfecf99fe">

<img width="797" alt="Screen Shot 2023-09-29 at 12 52 46 PM" src="https://github.com/gemartin99/Inception-Tutorial/assets/66915274/f3ae4683-a821-4278-b7fc-828936388ecc">

<img width="796" alt="Screen Shot 2023-09-29 at 1 00 38 PM" src="https://github.com/gemartin99/Inception-Tutorial/assets/66915274/fc3ec5d6-df9b-4723-840b-e1a3c203c4d6">

<img width="796" alt="Screen Shot 2023-09-29 at 1 12 48 PM" src="https://github.com/gemartin99/Inception-Tutorial/assets/66915274/33ad31b4-be0b-4e1b-acb9-d0e14df9f8a4">

<img width="800" alt="Screen Shot 2023-09-29 at 1 13 00 PM" src="https://github.com/gemartin99/Inception-Tutorial/assets/66915274/9b4f1226-a852-479f-a8d3-523f44c923a3">

<img width="797" alt="Screen Shot 2023-09-29 at 1 14 06 PM" src="https://github.com/gemartin99/Inception-Tutorial/assets/66915274/9c39135c-32ef-467c-87cb-9de7bab7af82">



## Archivo .yml

üß† Que es un archivo yml‚ùì

Es un archivo de configuraci√≥n utilizado para definir y gestionar m√∫ltiples contenedores en un entorno Docker. Permite describir las relaciones, configuraciones y servicios que compondr√°n una aplicaci√≥n o conjunto de servicios interconectados.

<img width="765" alt="Screen Shot 2023-10-03 at 12 25 20 AM" src="https://github.com/gemartin99/Inception-Tutorial/assets/66915274/8355f598-fe5f-4ae0-b3fc-5adcf0f94158">

```
networks:
    gemartinnet:
        name: gemartinnet
        driver: bridge
```

En este apartado definimos las redes. En este caso definimos una red llamada ```gemartinnet``` con el controlador de red como ```bridge```. Esto lo que va a indicar esque sera una red de tipo bridge, lo que permitira a los contenedores comunicarse entre s√≠ en el mismo host.

```
services:
    nginx:
        container_name: nginx
        build: ./requirements/nginx
        image: nginx
        ports:
        - 443:443
        volumes:
        - wordpress_data:/var/www/html
        restart: always
        networks:
        - gemartinnet
```

En este apartado se definen los servicios que ejecutaran los contenedores. El primer servicio es ```nginx```. Esto es lo que hacen las siguientes configuraciones:

container_name ‚Üí Asigna un nombre especifico al contenedor que se crea a partir de este servicio.

build ‚Üí Indica la ubicacion del Dockerfile y los archivos necesarios para construir la imagen del contenedor.

image ‚Üí Indica a docker que imagen debe usar como base para el servicio que estas definiendo. Si la imagen no se encuentra a nivel local en el sistema docker la descargara automaticamente.

ports ‚Üí Indicamos que queremos hacer un mapeo de puertos, esto es una redireccion de puertos de un sistema operativo a otro. Para explicarlo mejor, tenemos un servidor web (nginx) ejecutandose dentro del contenedor, por defecto no es accesible desde fuera del contenedor. Al hacer el mapeo de puertos especificaremos el puerto del servidor web para que este disponible desde el sistema anfitrion. Dicho esto ponemos 443:443 para indicar el PUERTO_DEL_HOST:PUERTO_DEL_CONTENEDOR. 

volumes ‚Üí Creamos un volumen en el host al directorio que especifiquemos en el contenedor. El proceso de montar un volumen se asemeja a "conectar" una carpeta del sistema operativo anfitri√≥n con una carpeta dentro del contenedor. Esto permite que los datos sean compartidos y persistan incluso despu√©s de que el contenedor se detenga o se reinicie. Es importante comentar que en esta parte solo diremos que el contenido del volumen llamado wordpress_data lo encontraremos en la ubicacion /var/www/html dentro del contenedor. La configuracion del volumen wordpress_data y mariadb_data es definida al final del fichero. Otra cosa importante a comentar es que WordPress y Nginx comparten volumen, esto lo utilizamos para servir archivos del sitio web desde el contenedor de NGINX, y si se actualizan o modifican esos archivos desde el contenedor WordPress los cambios se reflejar√°n inmediatamente en el sitio web sin necesidad de detener y volver a iniciar el contenedor de NGINX. Esto proporciona una forma eficiente de trabajar con aplicaciones web y mantener los datos consistentes.

restart ‚Üí Indica como debe comportarse el contenedor en caso de que se detenga. Basicamente lo que decimos es que si el contenedor asociado al servicio Nginx se detiene por algun motivo Docker lo reiniciara automaticamente.

networks ‚Üí Especifica a que red o redes debe estar conectado un contenedor. En nuestro caso le decimos que el contenedor asociado al servicio nginx estara conectada a la red gemartinnet.

```
mariadb:
    container_name: mariadb
    build:
       context: ./requirements/mariadb
    image: mariadb
    volumes:
     - mariadb_data:/var/lib/mysql
    restart: always
    networks:
     - gemartinnet
    env_file:
     - .env
```

Como todos los campos han sido explicados previamente menos env_file solo explicare este.

env_file ‚Üí Permite especificar un archivo que contiene variables de entorno para ser utilizadas por el contenedor. Estas variables de entorno pueden ser utilizadas dentro del contenedor, por la base de datos MariaDB en este caso, para configurar el entorno de ejecuci√≥n.

```
wordpress:
    container_name: wordpress
    build: ./requirements/wordpress
    image: wordpress
    depends_on:
     - mariadb
    volumes:
     - wordpress_data:/var/www/html
    restart: always
    networks:
     - gemartinnet
    env_file:
     - .env
```

Todos los campos han sido explicados previamente

```
volumes:
    mariadb_data:
        driver: local
        driver_opts:
            type: none
            device: /home/gemartin/data/mysql
            o: bind

    wordpress_data:
        driver: local
        driver_opts:
            type: none
            device: /home/gemartin/data/wordpress
            o: bind
```

Finalmente definimos los volumenes que hemos mencionado anteriormente. En estos campos especificaremos como seran manejados por Docker.

driver ‚Üí Define el tipo de controlador que Docker utilizara para manejar este volumen. En este caso ponemos local, lo que significa que el volumen estara almacenado en el sistema local de archivos del host.

driver_opts ‚Üí Es un conjunto de opciones especificas del controlador que permiten configurar como se va a manejar el volumen. En este caso establecemos 3 opciones: type, device y o. Vamos a explicar una por una.

- type ‚Üí Especifica el tipo de sistema de archivos que utilizara para el volumen. El uso que doy (none) indica que no se debe aplicar un tipo de sistema de archivos especifico. 

- device ‚Üí Especifica el directorio o dispositivo en el sistema de archivos del host que se utilizaran para almacenar los datos del volumen. 

- o (opciones de montaje) ‚Üí Esta es una serie de opciones que se utilizan cuando se monta el volumen. En este caso, o: bind indica que se debe realizar un enlace directo (bind) entre el volumen y el directorio del host, lo que permite que los datos sean accesibles desde el sistema de archivos del host.


# Nginx

üß† Que es un dockerfile‚ùì Es un archivo de configuraci√≥n utilizado para construir una imagen de contenedor en Docker.

## Dockerfile 

```
FROM debian:10.11

RUN apt-get update
RUN apt-get install -y nginx openssl

EXPOSE 443

COPY ./conf/default /etc/nginx/sites-enabled/default
COPY ./tools/nginx_start.sh /var/www

RUN chmod +x /var/www/nginx_start.sh

ENTRYPOINT [ "var/www/nginx_start.sh" ]

CMD ["nginx", "-g", "daemon off;"]
```

FROM ‚Üí Especifica la imagen base que se usara como punto de partida para construir el contenedor. En este caso utilizaremos Debian con la version 10.11. En un caso de uso real lo normal seria utilizar la imagen de nginx directamente pero el subject indica claramente que no se pueden utilizar imagenes preconfiguradas.

RUN ‚Üí Este comando ejecuta el comando dentro del contenedor. En este caso el comando lo que hara es actualizar la lista de paquetes disponibles en los repositorios debian. El siguiente comando run lo que hara es instalar dos paquetes nginx y openssl, el flag -y indica que se debe aceptar automaticamente todas las confirmaciones.

EXPOSE ‚Üí Especifica que puertos estan disponibles para ser expuestos cuando se ejecute el contenedor. En este caso sera el 443 aunque no tiene un efecto practico por si mismo, me explico, no abre el puerto ni realiza ningun enlace hacia fuera del contenedor. Sirve como informacion para el usuario sobre que puerto es utilizado por la aplicacion dentro del contenedor.

COPY ‚Üí Copia un archivo de configuracion desde el directorio especificado a nivel local al directorio especificado dentro del contenedor. En este caso copiaremos la configuracion por defecto de nginx a la ruta ```/etc/nginx/sites-enabled/default``` dentro de nuestro contenedor. Acto seguido hacemos lo mismo, en este caso copiamos el script nginx_start.sh al directorio ```/var/www``` del contenedor.

RUN ‚Üí Cambiaremos los permisos del script que acabamos de copiar al contenedor, de esta manera ya puede ser ejecutado.

ENTRYPOINT ‚Üí Define el comando que se ejecutara cuando el contenedor se inicie. En este caso se ejecutara el script nginx_start.sh, que es el que acabamos de copiar y cambiar los permisos.

CMD ‚Üí Establece el comando predeterminado que se ejecutara cuando el contenedor se inicie. En este caso lo que haremos sera iniciar el servidor nginx en modo demonio, esto lo que quiere decir es que el servidor se queda en ejecucion en segundo plano. La terminal esta libre para que el usuario, es decir, nosotros podamos utilizarla.

## Script Nginx

```
#!/bin/bash
if [ ! -f /etc/ssl/certs/nginx.crt ]; then
echo "Nginx: setting up ssl ...";
openssl req -x509 -nodes -days 365 -newkey rsa:4096 -keyout /etc/ssl/private/nginx.key -out /etc/ssl/certs/nginx.crt -subj "/C=ES/ST=Barcelona/L=Barcelona/O=wordpress/CN=gemartin.42.fr";
echo "Nginx: ssl is set up!";
fi
exec "$@"
```

Resumidamente , lo que hara este script es verificar si el certificado SSL (nginx.crt) existe en la ubicacion especificada. Si no existe lo generearemos y luego ejecutaremos los comandos que reciba como argumentos. Solo entrare en la explicacion de los campos escogidos para la generacion del certificado.

-x509 ‚Üí Indica que se debe generar un certificado autofirmado.

-nodes ‚Üí Significa que no se utilizara contrase√±a.

-days 365 ‚Üí Indica que el certificado sera valido 365 dias.

-newkey rsa:4096 ‚Üí Generara una nueva clase RSA de 4096 bits.

-keyout ruta ‚Üí Indica donde se guardara la clave privada.

-out ruta ‚Üí Indica donde se guardara el certificado.

-subj ‚Üí Establece los detalles del sujeto del certificado.

## Configuracion servidor nginx

```
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name gemartin.42.fr;

    ssl_certificate /etc/ssl/certs/nginx.crt;
    ssl_certificate_key /etc/ssl/private/nginx.key;
    ssl_protocols TLSv1.3;

    index index.php;
    root /var/www/html;
    location / {
        try_files $uri $uri/ /index.php$is_args$args;
    }
    location ~ \.php$ {
        try_files $uri =404;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass wordpress:9000;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
        fastcgi_read_timeout 300;
    }
}
```
server ‚Üí Indica el inicio de la configuracion del servidor.

listen 443 ssl ‚Üí Establece que el servidor escuchara por el puerto 443 y que se utilizara el protocolo SSL para las conexiones.

listen [::]:443 ssl ‚Üí Lo mismo que lo anterior pero esto sera para las conexiones IPv6. 

server_name gemartin.42.fr ‚Üí Especifica el nombre del servidor.

ssl_certificate ‚Üí Indica la ubicacion del certificado SSL.

ssl_certificate_key ‚Üí Indica la ubicacion de la clave privada correspondiente al certificado.

ssl_protocols TLSv1.3 ‚Üí Establece que el protocolo TLS version 1.3 sera utilizado.

index index.php ‚Üí Define el archivo que se utilizara como la pagina principal si el cliente no especifica una.

root /var/www/html ‚Üí Establece el directorio raiz del sitio web.

location / ‚Üí Define como manejar las peticiones a rutas que no coinciden con otras reglas.

location ~ ‚Üí Define como manejar las peticiones terminadas en .php.

# MariaDB

## Dockerfile

## Conf file

## Script MariaDB

<img width="805" alt="Screen Shot 2023-06-20 at 12 07 06 PM" src="https://github.com/gemartin99/inception/assets/66915274/0af6986c-f984-42c1-8a05-551b21ef3e25">

üî¥ Inicia el servicio MySQL. El servidor estara lito para aceptar conexiones.

üü† Condicion que si no existe el directorio de la base de datos entrara al if. Si no se cumple la condicion directamente pasara al paso üü§.

üü° Nos conectamos a MySQL mediante nuestro usuario y contrase√±a (utilizamos las variables de entorno) y ejecutamos la instruccion ```CREATE DATABASE $MYSQL_DATABASE;``` para crear una nueva base de datos con el nombre almacenado en la variable de entorno.

üü¢ Crearemos un usuario dentro de la base de datos especificando el nombre y la contrase√±a (utilizamos las variables de entorno).

üåê Le concedemos todos los permisos al usuario recien creado para que pueda acceder a la base de datos y realizar cualquier operaci√≥n en las tablas.

üîµ Actualizamos los privilegios para que los cambio realizados se apliquen.

üü£ Cambiamos la contrase√±a por defecto del usuario root de MySQL a la que tenemos almacenada en nuestra variable de entorno.

üü§ Apagamos el servidor utilizando el usuario y contrase√±a de root.

‚ö™Ô∏è Iniciamos el servidor MySQL de nuevo. Hemos realizado este reinicio para que el servidor se inicie con la configuracion y cambios realizados en el script.



















